{% extends 'registration/base_login.html' %}
{% load crispy_forms_tags %}

{% block title %}Iniciar Sesión{% endblock %}

{% block content %}
<div class="card shadow-lg border-0 rounded-lg">
    <div class="card-body p-5">
        
        <div class="mb-4 text-center">
            <h3 class="mt-3 text-dark">Acceso al Sistema</h3>
            <p class="text-muted">Inicia sesión con tu cuenta.</p>
        </div>

        <form id="loginForm" method="POST">
            {% csrf_token %}
            
            <div class="form-group text-left">
                <label for="id_email" class="text-dark">Correo Electrónico</label>
                <input type="email" name="email" id="id_email" class="form-control" required>
            </div>
            
            <div class="form-group text-left">
                <label for="id_password" class="text-dark">Contraseña</label>
                <input type="password" name="password" id="id_password" class="form-control" required>
            </div>
            
            <button type="submit" class="btn btn-success btn-block btn-lg mt-4">
                Entrar
            </button>

            <div id="error-message" class="text-danger mt-3" style="display:none;"></div>
        </form>

    </div>
    <div class="card-footer text-center text-muted py-3">
        Don Cucho
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const auth = firebase.auth();
    const loginForm = document.getElementById('loginForm');
    const errorMessage = document.getElementById('error-message');

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('id_email').value;
        const password = document.getElementById('id_password').value;
        
        errorMessage.style.display = 'none';
        errorMessage.textContent = '';

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            const idToken = await user.getIdToken();

            const response = await fetch('{% url "login_check" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`,
                    'X-CSRFToken': getCookie('csrftoken') 
                },
                body: JSON.stringify({ email: email })
            });

            if (response.ok) {
                window.location.href = '{% url "index" %}';
            } else {
                const errorData = await response.json();
                errorMessage.textContent = errorData.error || 'Error de verificación de permisos en el servidor.';
                errorMessage.style.display = 'block';
            }

        } catch (error) {
            let msg = 'Error desconocido. Revisa email y contraseña.';
            if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                msg = 'Usuario o email no encontrado.';
            } else if (error.code === 'auth/wrong-password') {
                msg = 'Contraseña incorrecta. Intenta de nuevo.';
            } else if (error.code === 'auth/network-request-failed') {
                msg = 'Error de red. Revisa tu conexión a internet.';
            } else if (error.code === 'auth/api-key-not-valid') {
                msg = 'ERROR DE CONFIGURACIÓN: La Clave API de Firebase no es válida. Revisa base_login.html.';
            }
            errorMessage.textContent = msg;
            errorMessage.style.display = 'block';
        }
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}